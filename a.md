## 模拟赛题解


### Povc3. 小Z学编程

考虑动规：

$f[i][j]$：处理到第$i$句话，且第$i$句缩进了$j$级的方案数。

如果上句话是`f`，第$i$句只能比上句多缩进一级。否则第$i$句的缩进数不超过上一句的缩进数。

状态转移方程为：
$$ f[i][j]=\left\{
\begin{aligned}
f[i-1][j-1]// f \\
\Sigma_{k=j}^{i-2} f[i-1][k] //s\\
\end{aligned}
\right.
$$

第二种情况所枚举的$k$是上个语句的位置，$j \le k \le i-2$的原因是上句的缩进数要大于等于第$i$句的且上句最多缩进$i-2$级。

考虑到转移的第二句等价于$f[i-1][j]+f[i][j+1]$，所以得到$O(n^2)$的转移。 

### P63eo. 圣诞树
首先可以将问题转化为

$A=\binom{|V(A)|}{2} -\sum_{i,j\in V(A)}[\operatorname{lca}(i,j)=i][w_i\leq w_j] +\sum_{i\in V(A)}d_i.$

$B=\sum_{i,j\in V(B)}[\operatorname{lca}(i,j)=i][w_i < w_j].$

考虑当 $V(B)=\{1,2,\cdots,n\}$ 时的不和谐度。

记 $a_i$ 表示权值比 $i$ 小的 $i$ 的祖先个数。

则此时不和谐度为 $\sum a_i$.

然后只需考虑将结点 $x$ 从 $V(B)$ 移到 $V(A)$ 对不和谐度产生的贡献。

先考虑任意两个结点的权值都不相等的情况：

- $\binom{|V(A)|}{2}$ 的改变容易计算；
- $\sum\limits_{i\in V(A)}d_i$ 将会增加 $d_x$；
- 另外两部分将会减少 $(x,y)$（$y\in V(A)$）有祖先关系且祖先的权值小于（等于）子孙的权值的方案数，以及 $(x,y)$（$y\in V(B)$）有祖先关系且祖先的权值小于子孙的权值的方案数。

在任意两个结点的权值都不相等时，这两部分之和显然是固定的。

若存在两个结点的权值相等，就需要额外减去 $(x,y)$（$y\in V(A)$）有祖先关系且祖先的权值等于子孙的权值的方案数。

设 $u$ 是 $v$ 的祖先，且 $u,v$ 权值向等，注意到 $a_v-a_u\leq d_v-d_u$，且 $b_v\leq b_u$，即 $d_u-a_u-b_u\leq d_v-a_v-b_v$。又因为让取的结点更浅可以让它和更多的子孙结点产生负贡献，所以权值相等时取祖先更优。

设 $b_i$ 表示权值大于 $w_i$ 的 $i$ 的子孙的个数， $c_i$ 表示权值等于 $w_i$ 的 $i$ 的祖先个数。

则把 $x$ 移到 $V(A)$ 的贡献就是 $d_x-a_x-b_x-c_x$（当然还有 $\binom{|V(A)|}{2}$ 的变化量），按照它从小到大的顺序移动即可。

$a,b,c$ 可以用树状数组快速求得，时间复杂度 $\Theta(n\log n)$。

### P111e. 迷宫传奇

题目有`3`种操作：
- 两点之间建边。
- 一个点向一个区间中每个点建边。
- 一个区间中的点向某个点建边。

可以考虑暴力建边，然后跑最短路。显然，时间、空间复杂度过高。

重点在于`2`、`3`操作，如果把它们做成$log$的才可以接受。大致的方向是用一个“代表节点”代表一个区间中的节点，用它来和单个的点建边，这样可以降低复杂度。

具体来说，可以考虑一种**线段树优化建图**的方法，用线段树来解决一些有关区间的问题是个不错的选择:

首先考虑操作`2`(一个点向一个区间中每个点建边):

- 建立线段树，每个点向其叶子节点建边（边权为`0`）。
- 将区间$[l,r]$分成线段树上的区间（个数在$log$级），建立$u$点与它们的连边。这样$u$与$[l,r]$中的每个节点都有了间接的联系（通过边权为`0`的边）。

操作`3`类似，只需改变线段树中边的方向。

然后考虑将两种操作结合，建立两棵线段树（一棵的边自上而下另一棵的边自下而上），对于它们的同一叶节点其实是图中的同一点，所以要将它们以边权为`0`的边相连。

最后只需跑一边最短路即可。

### Psqg1. 魔法基因

反转后相加一定得到回文串，最终的答案一定是通过向一个回文串前后加入字符得到的，于是将问题转为求所有回文串的答案。
            
考虑在回文自动机上$dp$，对于一个节点$i$，$fail_i$，$fa_i$可以向他贡献（操作$1$），$half_i$和$fa_i$形成之前的字符串可以向$i$贡献（操作$2$，前提是$i$是偶回文串）。
